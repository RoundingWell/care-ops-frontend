import{E,F as T,n as A,r as d,J as y,K as C,e as w,L as b,M as x,N as F}from"./20240916-index-DmCQ5wSx.js";import{r as K,c as L,d as Y,R as a,B as f,b as q,$ as R}from"./20240916-runtime-BjoFK27h.js";import{A as m}from"./20240916-app-DuOyuNDV.js";var _={exports:{}};/**
 * backbone.eventrouter - A highly opinionated, simplistic Backbone.Router coupled with a Backbone.Radio.Channel
 * @version v1.1.0
 * @link https://github.com/RoundingWellOS/backbone.eventrouter
 * @license MIT
 */(function(t,r){(function(e,n){t.exports=n(K,L,Y)})(E,function(e,n,h){e="default"in e?e.default:e,n="default"in n?n.default:n;var g=/(\(\?)?:\w+/,v=n.EventRouter=n.Router.extend({constructor:function(s){e.extend(this,e.pick(s,["channelName","routeTriggers"])),this.cid=e.uniqueId("bber"),this._ch=n.Radio.channel(e.result(this,"channelName")),this.listenTo(this._ch,"all",this.navigateFromEvent),n.Router.apply(this,arguments),this._initRoutes()},channelName:"event-router",getChannel:function(){return this._ch},_initRoutes:function(){this._routeTriggers=e.result(this,"routeTriggers",{}),e.each(this._routeTriggers,this._addRouteTrigger,this)},_addRouteTrigger:function(s,i){s=e.isArray(s)?s:[s],e.each(s,function(u){this.route(u,i,e.bind(this._ch.trigger,this._ch,i))},this)},addRouteTrigger:function(s,i){return this._routeTriggers[i]=s,this._addRouteTrigger(s,i),this},route:function(s,i,u){var c=n.Router.prototype.route;if(e.isFunction(i)||!u)return s=c.call(this,s,i,u),n.history.handlers[0].cid=this.cid,s;var p=e.bind(function(){var l=e.drop(arguments,0);this.trigger("before:route",i,l),this.trigger.apply(this,["before:route:"+i].concat(l)),this._storeRouteTrigger([i].concat(l)),u.apply(this,l),this._clearRouteTrigger()},this);return s=c.call(this,s,i,p),n.history.handlers[0].cid=this.cid,s},_storeRouteTrigger:function(s){this._routeArgs=this._routeArgs||[],this._routeArgs.push(s)},_getCurrentRouteTrigger:function(){return e.last(this._routeArgs)||[]},_clearRouteTrigger:function(){this._routeArgs.pop()},_isTriggeredFromRoute:function(){var s=this._getCurrentRouteTrigger();return arguments.length!==s.length?!1:arguments.length===e.union(arguments,s).length},navigateFromEvent:function(s){var i=this.getDefaultRoute(s);if(!i){var u=e.drop(arguments,0);return this.trigger.apply(this,["noMatch"].concat(u)),this}if(this._isTriggeredFromRoute.apply(this,arguments))return this;var c=e.drop(arguments,1),p=this.translateRoute(i,c);return this.navigate(p,{trigger:!1})},getDefaultRoute:function(s){var i=this._routeTriggers[s];return e.isArray(i)?i[0]:i},_replaceParam:function(s,i){return s.replace(g,i)},translateRoute:function(s,i){return e.reduce(i,this._replaceParam,s)},destroy:function(){return n.history.handlers=e.reject(n.history.handlers,{cid:this.cid}),this.stopListening(),this.trigger("destroy",this),this}});return v})})(_);var N=_.exports;const M=T(N),W=m.extend({routerAppName:"",constructor:function(){this.initRouter(),this.listenTo(this.router,"noMatch",this.onNoMatch),this.on("before:stop",this.stopCurrent),m.apply(this,arguments)},initRouter(){this._routes=A(this,"eventRoutes");const t=this.getRouteTriggers();this.router=new M({routeTriggers:t}),this.on("before:destroy",()=>this.router.destroy()),this.bindRouteEvents()},onNoMatch(){this.stop(),this._currentRoute=null},getRouteTriggers(){return d(this._routes,function(t,{route:r,root:e},n){if(e)return t[n]=r,t;const g=a.request("workspace","current").get("slug");return t[n]=r?`${g}/${r}`:g,t},{})},getEventActions(t,r){return d(t,function(e,{action:n},h){return e[h]=y(r,h,n),e},{})},bindRouteEvents(){const t=this.getEventActions(this._routes,this.routeAction);this.listenTo(this.router.getChannel(),t)},routeAction(t,r,...e){this.isRunning()||this.start(),this.triggerMethod("before:appRoute",t,...e),a.request("nav","select",this.routerAppName,t,e),a.request("sidebar","close"),this.setLatestList(t,e),this._currentRoute={event:t,eventArgs:e},C(r)||(r=this[r]),r.apply(this,e),this.triggerMethod("appRoute",t,...e)},setLatestList(t,r){if(this._routes[t].isList){a.request("history","set:latestList",t,r);return}this._routes[t].clearLatestList&&a.request("history","set:latestList",!1)},startCurrent(t,r){this.stopCurrent(),this._currentAppName=t,this._currentAppOptions=r,r=w({currentRoute:this._currentRoute},r);const e=this.startChildApp(t,r);return this._current=e,e},startRoute(t,r){return this.isCurrent(t,r)?this.getCurrent().startRoute(this.getCurrentRoute()):this.startCurrent(t,r)},getCurrent(){return this._current},isCurrent(t,r){return t===this._currentAppName&&b(r,this._currentAppOptions)},getCurrentRoute(){return this._currentRoute},stopCurrent(){this._current&&(this._current.stop(),this._current=null,this._currentAppName=null,this._currentAppOptions=null)},translateEvent(t){const r=this.router.getDefaultRoute(t);return this.router.translateRoute(r,x(arguments))},replaceRoute(){const t=this.translateEvent.apply(this,arguments);this.replaceUrl(t)},navigateRoute(){const t=this.translateEvent.apply(this,arguments);f.history.navigate(t,{trigger:!1})},replaceUrl(t){f.history.navigate(t,{trigger:!1,replace:!0})}}),$={BACKSPACE_KEY:8,TAB_KEY:9,ENTER_KEY:13,SHIFT_KEY:16,ESCAPE_KEY:27,LEFT_KEY:37,UP_KEY:38,RIGHT_KEY:39,DOWN_KEY:40,AT_KEY_SHIFT:50},j=q.extend({ui:{iframe:"iframe"},onInitialize(){this.channel=a.channel(`form${this.view.model.id}`)},replies:{send(t,r={}){this.ui.iframe[0].contentWindow.postMessage({message:t,args:r},window.origin)},focus(){a.trigger("user-activity","iframe:focus",this.ui.iframe[0])}},onAttach(){this.channel.reply(this.replies,this),R(window).on("message",({originalEvent:t})=>{const{data:r,origin:e}=t;e!==window.origin||!r||!r.message||this.channel.request(r.message,r.args)})},onBeforeDetach(){R(window).off("message"),this.channel.stopReplying(F(this.replies).join(" "))}});export{j as I,W as R,$ as k};
