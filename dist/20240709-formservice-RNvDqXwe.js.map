{"version":3,"file":"20240709-formservice-RNvDqXwe.js","sources":["../src/js/formservice.js"],"sourcesContent":["import 'js/base/setup';\n\nimport Backbone from 'backbone';\nimport Radio from 'backbone.radio';\n\nimport App from 'js/base/app';\n\nimport 'js/entities-service';\n\nimport { FORM_RESPONSE_STATUS } from 'js/static';\n\nconst ActionFormApp = App.extend({\n  beforeStart({ actionId }) {\n    return [\n      Radio.request('entities', 'fetch:forms:byAction', actionId),\n      Radio.request('entities', 'fetch:forms:definition:byAction', actionId),\n      Radio.request('entities', 'fetch:forms:data', actionId),\n      Radio.request('entities', 'fetch:actions:model', actionId),\n    ];\n  },\n  onStart(opts, form, definition, data, action) {\n    const filter = this._getPrefillFilters(form, action);\n\n    return Promise.resolve(Radio.request('entities', 'fetch:formResponses:latest', filter))\n      .then(response => {\n        parent.postMessage({ message: 'form:pdf', args: {\n          definition,\n          formData: data.attributes,\n          responseData: response.getFormData(),\n          formSubmission: response.getResponse(),\n          contextScripts: form.getContextScripts(),\n          loaderReducers: form.getLoaderReducers(),\n        } }, window.origin);\n      });\n  },\n  _getPrefillFilters(form, action) {\n    const opts = {\n      status: FORM_RESPONSE_STATUS.SUBMITTED,\n      flow: action.get('_flow'),\n      patient: action.get('_patient'),\n    };\n\n    const isReport = form.isReport();\n\n    if (isReport) opts.created = `<=${ action.get('created_at') }`;\n\n    const prefillActionTag = form.getPrefillActionTag();\n\n    if (prefillActionTag) {\n      opts['action.tags'] = prefillActionTag;\n\n      return opts;\n    }\n\n    opts.action = action.id;\n\n    return opts;\n  },\n});\n\nconst FormApp = App.extend({\n  beforeStart({ formId, patientId, responseId }) {\n    return [\n      Radio.request('entities', 'fetch:forms:model', formId),\n      Radio.request('entities', 'fetch:forms:definition', formId),\n      Radio.request('entities', 'fetch:forms:data', null, patientId, formId),\n      Radio.request('entities', 'fetch:formResponses:model', responseId),\n    ];\n  },\n  onStart(opts, form, definition, data, response) {\n    parent.postMessage({ message: 'form:pdf', args: {\n      definition,\n      formData: data.attributes,\n      responseData: response.getFormData(),\n      formSubmission: response.getResponse(),\n      contextScripts: form.getContextScripts(),\n      loaderReducers: form.getLoaderReducers(),\n    } }, window.origin);\n  },\n});\n\nconst Router = Backbone.Router.extend({\n  routes: {\n    'formservice/action/:actionId': 'startActionFormService',\n    'formservice/:formId/:patientId(/:responseId)': 'startFormService',\n  },\n  startActionFormService(actionId) {\n    const app = new ActionFormApp();\n\n    app.start({ actionId });\n  },\n  startFormService(formId, patientId, responseId) {\n    const app = new FormApp();\n\n    app.start({ formId, patientId, responseId });\n  },\n});\n\nfunction startFormServiceApp() {\n  new Router();\n  Backbone.history.start({ pushState: true });\n}\n\nexport {\n  startFormServiceApp,\n};\n"],"names":["ActionFormApp","App","actionId","Radio","opts","form","definition","data","action","filter","response","FORM_RESPONSE_STATUS","prefillActionTag","FormApp","formId","patientId","responseId","Router","Backbone","startFormServiceApp"],"mappings":"oPAMA,MAAMA,EAAgBC,EAAI,OAAO,CAC/B,YAAY,CACV,SAAAC,CACJ,EAAK,CACD,MAAO,CAACC,EAAM,QAAQ,WAAY,uBAAwBD,CAAQ,EAAGC,EAAM,QAAQ,WAAY,kCAAmCD,CAAQ,EAAGC,EAAM,QAAQ,WAAY,mBAAoBD,CAAQ,EAAGC,EAAM,QAAQ,WAAY,sBAAuBD,CAAQ,CAAC,CACjQ,EACD,QAAQE,EAAMC,EAAMC,EAAYC,EAAMC,EAAQ,CAC5C,MAAMC,EAAS,KAAK,mBAAmBJ,EAAMG,CAAM,EACnD,OAAO,QAAQ,QAAQL,EAAM,QAAQ,WAAY,6BAA8BM,CAAM,CAAC,EAAE,KAAKC,GAAY,CACvG,OAAO,YAAY,CACjB,QAAS,WACT,KAAM,CACJ,WAAAJ,EACA,SAAUC,EAAK,WACf,aAAcG,EAAS,YAAa,EACpC,eAAgBA,EAAS,YAAa,EACtC,eAAgBL,EAAK,kBAAmB,EACxC,eAAgBA,EAAK,kBAAmB,CACzC,CACT,EAAS,OAAO,MAAM,CACtB,CAAK,CACF,EACD,mBAAmBA,EAAMG,EAAQ,CAC/B,MAAMJ,EAAO,CACX,OAAQO,EAAqB,UAC7B,KAAMH,EAAO,IAAI,OAAO,EACxB,QAASA,EAAO,IAAI,UAAU,CACpC,EACqBH,EAAK,aACRD,EAAK,QAAU,KAAKI,EAAO,IAAI,YAAY,CAAC,IAC1D,MAAMI,EAAmBP,EAAK,sBAC9B,OAAIO,GACFR,EAAK,aAAa,EAAIQ,EACfR,IAETA,EAAK,OAASI,EAAO,GACdJ,EACR,CACH,CAAC,EACKS,EAAUZ,EAAI,OAAO,CACzB,YAAY,CACV,OAAAa,EACA,UAAAC,EACA,WAAAC,CACJ,EAAK,CACD,MAAO,CAACb,EAAM,QAAQ,WAAY,oBAAqBW,CAAM,EAAGX,EAAM,QAAQ,WAAY,yBAA0BW,CAAM,EAAGX,EAAM,QAAQ,WAAY,mBAAoB,KAAMY,EAAWD,CAAM,EAAGX,EAAM,QAAQ,WAAY,4BAA6Ba,CAAU,CAAC,CACxQ,EACD,QAAQZ,EAAMC,EAAMC,EAAYC,EAAMG,EAAU,CAC9C,OAAO,YAAY,CACjB,QAAS,WACT,KAAM,CACJ,WAAAJ,EACA,SAAUC,EAAK,WACf,aAAcG,EAAS,YAAa,EACpC,eAAgBA,EAAS,YAAa,EACtC,eAAgBL,EAAK,kBAAmB,EACxC,eAAgBA,EAAK,kBAAmB,CACzC,CACP,EAAO,OAAO,MAAM,CACjB,CACH,CAAC,EACKY,EAASC,EAAS,OAAO,OAAO,CACpC,OAAQ,CACN,+BAAgC,yBAChC,+CAAgD,kBACjD,EACD,uBAAuBhB,EAAU,CACnB,IAAIF,IACZ,MAAM,CACR,SAAAE,CACN,CAAK,CACF,EACD,iBAAiBY,EAAQC,EAAWC,EAAY,CAClC,IAAIH,IACZ,MAAM,CACR,OAAAC,EACA,UAAAC,EACA,WAAAC,CACN,CAAK,CACF,CACH,CAAC,EACD,SAASG,GAAsB,CAC7B,IAAIF,EACJC,EAAS,QAAQ,MAAM,CACrB,UAAW,EACf,CAAG,CACH"}